services:
  mysql:
    image: mysql:8.0
    container_name: pettrack-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "PetTrack2025"
      MYSQL_DATABASE: pettrack_db
      MYSQL_ALLOW_EMPTY_PASSWORD: "no"
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - pettrack-network
    command: --default-authentication-plugin=mysql_native_password

  auth-service:
    image: ${ACR_LOGIN_SERVER}/pettrack-auth-service:latest
    container_name: pettrack-auth
    ports:
      - "8000:8000"
    environment:
      - APP_NAME=auth_service
      - APP_ENV=production
      - PORT=8000
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=pettrack_db
      - DATABASE_URL=mysql+pymysql://root:${DB_PASSWORD}@mysql:3306/pettrack_db
      - SECRET_KEY=${SECRET_KEY}
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - pettrack-network

  pets-service:
    image: ${ACR_LOGIN_SERVER}/pettrack-pets-service:latest
    container_name: pettrack-pets
    ports:
      - "8001:8001"
    environment:
      - APP_NAME=pets_service
      - APP_ENV=production
      - PORT=8001
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=pettrack_db
      - DATABASE_URL=mysql+pymysql://root:${DB_PASSWORD}@mysql:3306/pettrack_db
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - pettrack-network

  appointment-service:
    image: ${ACR_LOGIN_SERVER}/pettrack-appointment-service:latest
    container_name: pettrack-appointments
    ports:
      - "8002:8002"
    environment:
      - APP_NAME=appointment_service
      - APP_ENV=production
      - PORT=8002
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=pettrack_db
      - DATABASE_URL=mysql+pymysql://root:${DB_PASSWORD}@mysql:3306/pettrack_db
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - pettrack-network

  rewards-service:
    image: ${ACR_LOGIN_SERVER}/pettrack-rewards-service:latest
    container_name: pettrack-rewards
    ports:
      - "8004:8004"
    environment:
      - APP_NAME=rewards_service
      - APP_ENV=production
      - PORT=8004
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=pettrack_db
      - DATABASE_URL=mysql+pymysql://root:${DB_PASSWORD}@mysql:3306/pettrack_db
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - pettrack-network

  postconsult-service:
    image: ${ACR_LOGIN_SERVER}/pettrack-postconsult-service:latest
    container_name: pettrack-postconsult
    ports:
      - "8005:8005"
    environment:
      - APP_NAME=postconsult_service
      - APP_ENV=production
      - PORT=8005
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=pettrack_db
      - DATABASE_URL=mysql+pymysql://root:${DB_PASSWORD}@mysql:3306/pettrack_db
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - pettrack-network

  web-client:
    image: ${ACR_LOGIN_SERVER}/pettrack-web-client:latest
    container_name: pettrack-web
    ports:
      - "3000:80"
    environment:
      - VITE_API_GATEWAY=http://40.65.63.210:8003
    restart: unless-stopped
    depends_on:
      - auth-service
      - pets-service
      - appointment-service
    networks:
      - pettrack-network

networks:
  pettrack-network:
    driver: bridge

volumes:
  mysql_data:
    driver: local