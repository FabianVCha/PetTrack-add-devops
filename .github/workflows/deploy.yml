name: CI/CD to VM

on:
  push:
    branches: [ main ]

env:
  TAG: latest
  COMMIT_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ðŸ³ Login ACR
    - name: Docker Login to ACR
      run: |
        echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ secrets.ACR_LOGIN_SERVER }} -u ${{ secrets.ACR_USERNAME }} --password-stdin

    # ðŸ—ï¸ Build + Tag
    - name: Build Docker Images
      run: |
        REGISTRY=${{ secrets.ACR_LOGIN_SERVER }}

        docker build -t $REGISTRY/pettrack-auth-service:${{ env.TAG }} ./services/auth-service
        docker build -t $REGISTRY/pettrack-pets-service:${{ env.TAG }} ./services/pets-service
        docker build -t $REGISTRY/pettrack-appointment-service:${{ env.TAG }} ./services/appointment-service
        docker build -t $REGISTRY/pettrack-rewards-service:${{ env.TAG }} ./services/rewards-service
        docker build -t $REGISTRY/pettrack-postconsult-service:${{ env.TAG }} ./services/postconsult-service
        docker build -t $REGISTRY/pettrack-web-client:${{ env.TAG }} ./clients/web-client

        docker tag $REGISTRY/pettrack-auth-service:${{ env.TAG }} $REGISTRY/pettrack-auth-service:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-pets-service:${{ env.TAG }} $REGISTRY/pettrack-pets-service:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-appointment-service:${{ env.TAG }} $REGISTRY/pettrack-appointment-service:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-rewards-service:${{ env.TAG }} $REGISTRY/pettrack-rewards-service:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-postconsult-service:${{ env.TAG }} $REGISTRY/pettrack-postconsult-service:${{ env.COMMIT_TAG }}
        docker tag $REGISTRY/pettrack-web-client:${{ env.TAG }} $REGISTRY/pettrack-web-client:${{ env.COMMIT_TAG }}

    # ðŸ“¤ Push
    - name: Push Images
      run: |
        REGISTRY=${{ secrets.ACR_LOGIN_SERVER }}
        
        docker push $REGISTRY/pettrack-auth-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-pets-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-appointment-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-rewards-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-postconsult-service:${{ env.TAG }}
        docker push $REGISTRY/pettrack-web-client:${{ env.TAG }}
        
        docker push $REGISTRY/pettrack-auth-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-pets-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-appointment-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-rewards-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-postconsult-service:${{ env.COMMIT_TAG }}
        docker push $REGISTRY/pettrack-web-client:${{ env.COMMIT_TAG }}

    # ðŸŸ¢ SSH â€” Ejecutar deploy en la VM
    - name: Deploy to VM via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
          host: ${{ secrets.VM_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script_stop: true
          script: |
            cd /home/fvasquezc/pettrack
            echo "ACR_LOGIN_SERVER=${{ secrets.ACR_LOGIN_SERVER }}" > .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
            chmod +x deploy.sh
            ./deploy.sh
